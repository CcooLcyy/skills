---
name: git-commit
description: 用于在本地仓库完成 git 提交流程：分析未暂存改动、询问排除文件、暂存修改、按功能点拆分提交、根据仓库现有规范生成提交信息并执行提交。用户提到 git 提交、提交信息、提交规范、拆分提交或提交失败需要重试等场景时使用。
---

# Git 提交

## 工作流

- 固定顺序：先划分改动点，再暂存关联改动，再生成提交信息，最后提交。
- 强制要求：调用本技能时必须完成“暂存修改”和“生成提交信息”两步，不要跳过。

1. 读取状态与未暂存改动
   - 执行 `git status -sb`，`git diff`，必要时补充 `git diff --stat`。
   - 若存在已暂存改动，列出并确认是否保留或需要拆分。
   - 先按修改点/功能点归类，作为后续暂存分组依据。

2. 询问排除文件
   - 列出未暂存文件清单。
   - 主动按类型提示可能不提交的文件，例如：JSON 配置、密钥、生成物、日志、大文件。
   - 获取用户确认的排除列表；如需长期忽略，更新 `.gitignore`。

3. 按功能点拆分提交
   - 按前面划分的修改点分组暂存，优先使用 `git add -p` 或逐文件暂存，确保完成暂存。
   - 每个批次暂存后展示 `git diff --cached` 并确认内容完整。
   - 暂存完成后再生成该批次提交信息，避免先写提交信息再补改动。
   - 若存在多批次，逐批次生成提交信息草稿但先汇总，等所有批次准备完后一次性输出。

4. 发现仓库提交规范
   - 查找规范与模板：`CONTRIBUTING.md`、`README.md`、`docs/`、`.gitmessage*`、`.commitlintrc*`、`commitlint.config.*`、`package.json` 中的 commitlint/commitizen 配置、`git config commit.template`。
   - 若存在模板或规范，严格遵循。
   - 若找不到规范，参考仓库最近提交信息的格式/风格；若无可参考内容，直接生成简洁一致的提交信息。

5. 生成提交信息
   - 根据规范或既有提交信息风格生成标题/正文/脚注，按仓库语言要求编写，必须给出提交信息候选。
   - 提交信息必须使用真实换行，禁止输出字面量 `\n` 作为换行符；标题与正文之间保留一个空行，正文每条要点独占一行。
   - 提交信息需要详细：标题概括改动主题，正文列出本批次改动点/影响范围/关键原因，确保读者无需查看 diff 也能理解变化。
   - 需要工单号或 issue id 时，主动询问并补齐。
   - 若为多批次提交，一次性输出所有批次的提交信息候选，统一确认与调整。

6. 提交
   - 使用 `git commit` 提交该批次。
   - 若有多批次，重复第 3-6 步。
   - 仅在用户明确要求时执行 `git push`。

## 质量与安全

- 在执行可能耗时的测试或格式化前，先询问用户是否需要运行。
- 若提交失败（如 hook/commitlint），读取错误信息，修正提交信息或拆分策略后重试。
